<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>由 tauri 单例模式 bug “意外修复” 发现的 dangling - huangjj27&#x27;s Tech blog</title>


        <!-- Custom HTML head -->
        
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="tauri-single-instance-bug-dangling.html" class="active">由 tauri 单例模式 bug “意外修复” 发现的 dangling</a></li><li class="chapter-item expanded "><a href="load-wasm-mistake.html">尝试在单 HTML 文件中嵌入 WASM 模块的错误操作</a></li><li class="chapter-item expanded "><a href="reservoir.html">蓄水池算法改进 - 面向抽奖场景保证等概率性</a></li><li class="chapter-item expanded "><a href="interview.html">记一次面试</a></li><li class="chapter-item expanded "><a href="snake-with-bevy.html">用 Bevy 游戏引擎编写贪吃蛇（译）</a></li><li class="chapter-item expanded "><a href="rust-safe-apps-51.html">Rust 安全应用开发51条</a></li><li class="chapter-item expanded "><a href="rust-tianhe-ii.html">在天河二号上配置 Rust 运行环境</a></li><li class="chapter-item expanded "><a href="rust-patterns/intro.html">设计模式在 Rust 中的实践</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="rust-patterns/builder.html">构建器（Builder）模式</a></li><li class="chapter-item expanded "><a href="rust-patterns/abstract-factory.html">抽象工厂（Abstract Factory）模式</a></li></ol></li><li class="chapter-item expanded "><a href="rust-mirror.html">Rust 镜像</a></li><li class="chapter-item expanded "><a href="rust-ffi.html">在 WSL 中学习 Rust FFI</a></li><li class="chapter-item expanded "><a href="wasi/intro.html">WASI探索</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="wasi/wasi_and_wasmtime.html">WASI简介与Wasmtime配置</a></li><li class="chapter-item expanded "><a href="wasi/wasi_guess.html">WASI版猜数字</a></li></ol></li><li class="chapter-item expanded "><a href="number_theory/intro.html">初等数论自我探索</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="number_theory/if_2n-p_is_divided_by_p.html">若质数p不能整除偶数2n，则p不整除2n-p</a></li><li class="chapter-item expanded "><a href="number_theory/single-composite-divsion.html">整数和它两倍间的合数的性质</a></li><li class="chapter-item expanded "><a href="number_theory/goldbachs-conjecture.html">用初等数论探索哥德巴赫猜想</a></li><li class="spacer"></li></ol></li><li class="chapter-item expanded "><a href="resume.html">关于我</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">huangjj27&#x27;s Tech blog</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/huangjj27/huangjj27.github.io" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="由-tauri-单例模式-bug-意外修复-发现的-dangling"><a class="header" href="#由-tauri-单例模式-bug-意外修复-发现的-dangling">由 tauri 单例模式 bug “意外修复” 发现的 dangling</a></h1>
<h2 id="tldr"><a class="header" href="#tldr">TL;DR</a></h2>
<p><a href="https://github.com/tauri-apps/tauri-plugin-single-instance">tauri 单例插件</a> 用于区分单例实例的 <code>productName</code>的过长会导致<a href="https://github.com/amrbashir/tauri-plugin-single-instance/issues/5">单例功能失效</a>，博主最初确信 <code>encode_wide</code> 实现有问题，并提交了<a href="https://github.com/huangjj27/tauri-plugin-single-instance/commit/6fd3c8c2c518eb5eaa1101eb14a65603ca5e621e">修复</a>。然而在和社区深入研究问题原因后，发现根本原因是使用 <code>encode_wide</code> 转码传参时造成了 <a href="https://github.com/tauri-apps/tauri-plugin-single-instance/pull/6">dangling</a> 。</p>
<p>PS: 为方便读者理解，博主花费一天时间重新梳理分析步骤，按照演绎法展示定位 bug 地过程，实现发生的分析过程要比博文的过程更加曲折，对分析理解问题无意义因此略过。</p>
<h2 id="所以这个-bug-的现象是怎么样的"><a class="header" href="#所以这个-bug-的现象是怎么样的">所以这个 bug 的现象是怎么样的？</a></h2>
<p>正如博主所说，在 <a href="https://github.com/tauri-apps/tauri-plugin-single-instance/blob/16e5e9eb59da9ceca3dcf09c81120b37fe108a03/src/platform_impl/windows.rs">有问题版本的插件代码</a> 中，博主最初发现，<code>tauri.conf.json</code> 中的 <code>package.productName</code> 在分别使用五个汉字与六个汉字时，单例模式功能表现出不一致的行为：五个汉字的 <code>productName</code> 单例功能运行正常，而六个汉字的 <code>productName</code> 单例功能失效，于是针对该问题初步进行了测试：</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">测试的 <code>productName</code></th><th style="text-align: center">单例插件功能是否生效</th></tr></thead><tbody>
<tr><td style="text-align: left">六个汉字试试</td><td style="text-align: center">x</td></tr>
<tr><td style="text-align: left">随便五个字</td><td style="text-align: center">√</td></tr>
<tr><td style="text-align: left">又来了六个字</td><td style="text-align: center">x</td></tr>
</tbody></table>
</div>
<p>因为这些汉字测试用例使用 <code>UTF-8</code> 编码，又因为是常用字，因此每个汉字对应 3 bytes，因此假设 <code>productName</code> 在超过 15 bytes、不超过 18 bytes 时会导致功能失效，进一步补充测试用例：</p>
<div class="table-wrapper"><table><thead><tr><th style="text-align: left">测试的 <code>productName</code></th><th style="text-align: center">单例插件功能是否生效</th></tr></thead><tbody>
<tr><td style="text-align: left">z12345678901234</td><td style="text-align: center">√</td></tr>
<tr><td style="text-align: left">z123456789012345</td><td style="text-align: center">x</td></tr>
</tbody></table>
</div>
<p>看来博主运气不错，刚好踩到了边界的测试用例。那么基本可以确定，<code>productName</code> 超过 15 bytes 就会导致单例功能失效。</p>
<h2 id="potatotoolarge-传递给-win32-api-的字符串要用-c-string-风格的-0-结束"><a class="header" href="#potatotoolarge-传递给-win32-api-的字符串要用-c-string-风格的-0-结束">PotatoTooLarge: 传递给 Win32 API 的字符串要用 C string 风格的 <code>\0</code> 结束</a></h2>
<p>在最初的讨论过程中，因为我们没有仔细留意插件仓库使用的 <code>encode_wide</code> 是自行做过封装的，因此我们一开始根据 <a href="https://github.com/tauri-apps/tauri-plugin-single-instance/blob/16e5e9eb59da9ceca3dcf09c81120b37fe108a03/src/platform_impl/windows.rs">以下代码</a> 进行分析：</p>
<pre><code class="language-rs">pub fn init&lt;R: Runtime&gt;(f: Box&lt;SingleInstanceCallback&lt;R&gt;&gt;) -&gt; TauriPlugin&lt;R&gt; {
    plugin::Builder::new(&quot;single-instance&quot;)
        .setup(|app| {
            let app_name = &amp;app.package_info().name;
            let class_name = format!(&quot;{}-single-instance-class&quot;, app_name);
            let window_name = format!(&quot;{}-single-instance-window&quot;, app_name);

            let hmutex = unsafe {
                CreateMutexW(
                    std::ptr::null(),
                    true.into(),
                    encode_wide(&quot;tauri-plugin-single-instance-mutex&quot;).as_ptr(),
                )
            };

            if unsafe { GetLastError() } == ERROR_ALREADY_EXISTS {
                unsafe {
                    let hwnd = FindWindowW(
                        encode_wide(&amp;class_name).as_ptr(),
                        encode_wide(&amp;window_name).as_ptr(),
                    );

                    // omitted
                }

                // omitted
            }

            // omitted
        })
        .on_event(|app, event| {
            // omitted
        })
        .build()
}
</code></pre>
<p>有 Windows 编程经验的 @PotatoTooLarge 指出，<code>encode_wide</code>（来自 <a href="https://doc.rust-lang.org/std/os/windows/ffi/trait.OsStrExt.html#tymethod.encode_wide">std 的 Window扩展</a>）并不会补充 <code>\0</code> 结束符：</p>
<blockquote>
<p>Re-encodes an OsStr as a wide character sequence, i.e., potentially ill-formed UTF-16.</p>
<p>This is lossless: calling OsStringExt::from_wide and then encode_wide on the result will yield the original code units. <strong>Note that the encoding does not add a final null terminator.</strong></p>
</blockquote>
<p>于是博主听取建议，把所有会传递到 <code>encode_wide</code> 函数的字符串都添加了 <code>\0</code>，形成了 <a href="https://github.com/huangjj27/tauri-plugin-single-instance/commit/6fd3c8c2c518eb5eaa1101eb14a65603ca5e621e">一版修复</a>:</p>
<pre><code class="language-rs">pub fn init&lt;R: Runtime&gt;(f: Box&lt;SingleInstanceCallback&lt;R&gt;&gt;) -&gt; TauriPlugin&lt;R&gt; {
    plugin::Builder::new(&quot;single-instance&quot;)
        .setup(|app| {
            let app_name = &amp;app.package_info().name;
            // let class_name = format!(&quot;{}-single-instance-class&quot;, app_name);
            let class_name = format!(&quot;{}-single-instance-class\0&quot;, app_name);
            // let window_name = format!(&quot;{}-single-instance-window&quot;, app_name);
            let window_name = format!(&quot;{}-single-instance-window\0&quot;, app_name);

            let hmutex = unsafe {
                CreateMutexW(
                    std::ptr::null(),
                    true.into(),
                    // encode_wide(&quot;tauri-plugin-single-instance-mutex&quot;).as_ptr(),
                    encode_wide(&quot;tauri-plugin-single-instance-mutex\0&quot;).as_ptr(),
                )
            };

            if unsafe { GetLastError() } == ERROR_ALREADY_EXISTS {
                unsafe {
                    let hwnd = FindWindowW(
                        encode_wide(&amp;class_name).as_ptr(),
                        encode_wide(&amp;window_name).as_ptr(),
                    );

                    // omitted
                }

                // omitted
            }

            // omitted
        })
        .on_event(|app, event| {
            // omitted
        })
        .build()
}
</code></pre>
<p>然后使用修复前会引起单例功能失效的 <code>z123456789012345</code> 作为测试用例，验证单例功能可用了，证明该修改可以修复单例功能失效的问题。</p>
<h2 id="但它并不是真的修复"><a class="header" href="#但它并不是真的修复">但它并不是真的修复</a></h2>
<p>在博主提交了修复后，插件仓库作者提醒，前文所述的代码使用的 <code>encode_wide</code> 是<a href="https://github.com/tauri-apps/tauri-plugin-single-instance/blob/16e5e9eb59da9ceca3dcf09c81120b37fe108a03/src/platform_impl/windows.rs#L189">封装拼接了 <code>\0</code></a> 后再传递参数的:</p>
<pre><code class="language-rs">pub fn encode_wide(string: impl AsRef&lt;std::ffi::OsStr&gt;) -&gt; Vec&lt;u16&gt; {
    std::os::windows::prelude::OsStrExt::encode_wide(string.as_ref())
        .chain(std::iter::once(0))
        .collect()
}
</code></pre>
<p>这意味着，并不是 <code>\0</code> 导致问题的失效，因为该函数在 windows 环境下执行是能够补足 <code>\0</code> 的：</p>
<pre><code class="language-rs">fn encode_wide(string: impl AsRef&lt;std::ffi::OsStr&gt;) -&gt; Vec&lt;u16&gt; {
    std::os::windows::prelude::OsStrExt::encode_wide(string.as_ref())
        .chain(std::iter::once(0))
        .collect()
}

fn main() {
    let product_name = &quot;z123456789012345&quot;;

    // output: [122, 49, 50, 51, 52, 53, 54, 55, 56, 57, 48, 49, 50, 51, 52, 53, 0]
    //                                                                           ^
    //                              null concated here so it's null-terminated --|
    println!(&quot;{:?}&quot;, encode_wide(product_name));
}
</code></pre>
<h2 id="那么失效的过程发生了什么"><a class="header" href="#那么失效的过程发生了什么">那么失效的过程发生了什么？</a></h2>
<p>为了分析问题详细过程，我将插件仓库代码切换到了 <a href="https://github.com/tauri-apps/tauri-plugin-single-instance/blob/16e5e9eb59da9ceca3dcf09c81120b37fe108a03/src/platform_impl/windows.rs">问题代码版本</a>：</p>
<pre><code class="language-sh">git checkout 16e5e9eb59da9ceca3dcf09c81120b37fe108a03
</code></pre>
<p>然后添加了一些 <code>dbg</code> 宏：</p>
<pre><code class="language-rs">pub fn init&lt;R: Runtime&gt;(f: Box&lt;SingleInstanceCallback&lt;R&gt;&gt;) -&gt; TauriPlugin&lt;R&gt; {
    plugin::Builder::new(&quot;single-instance&quot;)
        .setup(|app| {
            let app_name = &amp;app.package_info().name;
            let class_name = format!(&quot;{}-single-instance-class&quot;, app_name);
            let window_name = format!(&quot;{}-single-instance-window&quot;, app_name);

            let hmutex = unsafe {
                CreateMutexW(
                    std::ptr::null(),
                    true.into(),
                    encode_wide(&quot;tauri-plugin-single-instance-mutex&quot;).as_ptr(),
                )
            };
            dbg!(hmutex);  // windows.rs:43 debug here!

            if unsafe { GetLastError() } == ERROR_ALREADY_EXISTS {
                unsafe {
                    let hwnd = FindWindowW(
                        encode_wide(&amp;class_name).as_ptr(),
                        encode_wide(&amp;window_name).as_ptr(),
                    );
                    dbg!(hwnd);  // windows.rs:51 debug here!

                    // omitted
                }
            } else {
                app.manage(MutexHandle(hmutex));

                let hwnd = create_event_target_window::&lt;R&gt;(&amp;class_name, &amp;window_name);
                dbg!(hwnd);  // windows.rs:76 debug here!

                // omitted
            }

            Ok(())
        })
        .on_event(|app, event| {
            // omitted
        })
        .build()
}
</code></pre>
<p>然后，将代码仓库  <code>examples\emit-event\src-tauri\tauri.conf.json</code> 分别改成 <code>z12345678901234</code> 与 <code>z123456789012345</code>，然后执行：</p>
<pre><code># process1
&gt; cd examples\emit-event
examples\emit-event&gt; cargo tauri build --debug
examples\emit-event&gt; src-tauri\target\debug\z12345678901234.exe
[tauri-plugin-single-instance\src\platform_impl\windows.rs:43] hmutex = 548
[tauri-plugin-single-instance\src\platform_impl\windows.rs:76] hwnd = 40113446

# process2
&gt; examples\emit-event\src-tauri\target\debug\z12345678901234.exe
[tauri-plugin-single-instance\src\platform_impl\windows.rs:43] hmutex = 548
[tauri-plugin-single-instance\src\platform_impl\windows.rs:51] hwnd = 40113446
</code></pre>
<pre><code># process1
&gt; cd examples\emit-event
examples\emit-event&gt; cargo tauri build --debug
examples\emit-event&gt; src-tauri\target\debug\z123456789012345.exe
[tauri-plugin-single-instance\src\platform_impl\windows.rs:43] hmutex = 552
[tauri-plugin-single-instance\src\platform_impl\windows.rs:76] hwnd = 0

# process2
&gt; examples\emit-event\src-tauri\target\debug\z123456789012345.exe
[tauri-plugin-single-instance\src\platform_impl\windows.rs:43] hmutex = 548
[tauri-plugin-single-instance\src\platform_impl\windows.rs:51] hwnd = 0

# process3
&gt; examples\emit-event\src-tauri\target\debug\z123456789012345.exe
[tauri-plugin-single-instance\src\platform_impl\windows.rs:43] hmutex = 548
[tauri-plugin-single-instance\src\platform_impl\windows.rs:51] hwnd = 0
</code></pre>
<p>由上面的结果我们可以知道：在用例 <code>z12345678901234</code>，我们在创建实实例时返回了有效的 <code>hwnd</code> 值，并且在检查 <code>hwnd</code> 时确认已经创建窗口；而在用例 <code>z123456789012345</code>，我们创建窗口的函数 <code>create_event_target_window</code> 返回的 <code>hwnd</code> 是无效的！所以导致问题的代码，应该在 <code>create_event_target_window</code> 的逻辑中！再次添加 <code>dbg</code> ，重新编译后继续 debug：</p>
<pre><code class="language-rs">fn create_event_target_window&lt;R: Runtime&gt;(class_name: &amp;str, window_name: &amp;str) -&gt; HWND {
    unsafe {
        let class = WNDCLASSEXW {
            cbSize: std::mem::size_of::&lt;WNDCLASSEXW&gt;() as u32,
            style: 0,
            lpfnWndProc: Some(single_instance_window_proc::&lt;R&gt;),
            cbClsExtra: 0,
            cbWndExtra: 0,
            hInstance: GetModuleHandleW(std::ptr::null()),
            hIcon: 0,
            hCursor: 0,
            hbrBackground: 0,
            lpszMenuName: std::ptr::null(),
            lpszClassName: encode_wide(&amp;class_name).as_ptr(),
            hIconSm: 0,
        };
        dbg!(class.lpszClassName);  // windows.rs:153 debug here
        dbg!(*class.lpszClassName);  // windows.rs:154 debug here

        RegisterClassExW(&amp;class);

        let hwnd = CreateWindowExW(
            WS_EX_NOACTIVATE
            | WS_EX_TRANSPARENT
            | WS_EX_LAYERED
            // WS_EX_TOOLWINDOW prevents this window from ever showing up in the taskbar, which
            // we want to avoid. If you remove this style, this window won't show up in the
            // taskbar *initially*, but it can show up at some later point. This can sometimes
            // happen on its own after several hours have passed, although this has proven
            // difficult to reproduce. Alternatively, it can be manually triggered by killing
            // `explorer.exe` and then starting the process back up.
            // It is unclear why the bug is triggered by waiting for several hours.
            | WS_EX_TOOLWINDOW,
            dbg!(encode_wide(&amp;class_name).as_ptr()),  // windows.rs:170 debug here
            dbg!(encode_wide(&amp;window_name).as_ptr()),  // windows.rs:171 debug here
            WS_OVERLAPPED,
            0,
            0,
            0,
            0,
            0,
            0,
            GetModuleHandleW(std::ptr::null()),
            std::ptr::null(),
        );
        SetWindowLongPtrW(
            hwnd,
            GWL_STYLE,
            // The window technically has to be visible to receive WM_PAINT messages (which are used
            // for delivering events during resizes), but it isn't displayed to the user because of
            // the LAYERED style.
            (WS_VISIBLE | WS_POPUP) as isize,
        );
        hwnd
    }
}
</code></pre>
<p><code>z12345678901234</code>:</p>
<pre><code>examples\emit-event&gt; src-tauri\target\debug\z12345678901234.exe
[tauri-plugin-single-instance\src\platform_impl\windows.rs:43] hmutex = 556
[tauri-plugin-single-instance\src\platform_impl\windows.rs:153] class.lpszClassName = 0x0000021d099eddc0
[tauri-plugin-single-instance\src\platform_impl\windows.rs:154] *class.lpszClassName = 122
[tauri-plugin-single-instance\src\platform_impl\windows.rs:170] encode_wide(&amp;class_name).as_ptr() = 0x0000021d099ee180
[tauri-plugin-single-instance\src\platform_impl\windows.rs:171] encode_wide(&amp;window_name).as_ptr() = 0x0000021d099dfe20
[tauri-plugin-single-instance\src\platform_impl\windows.rs:76] hwnd = 28841288
</code></pre>
<p><code>z123456789012345</code>:</p>
<pre><code>examples\emit-event&gt; src-tauri\target\debug\z123456789012345.exe
[tauri-plugin-single-instance\src\platform_impl\windows.rs:43] hmutex = 548
[tauri-plugin-single-instance\src\platform_impl\windows.rs:153] class.lpszClassName = 0x0000017259ca6be0
[tauri-plugin-single-instance\src\platform_impl\windows.rs:154] *class.lpszClassName = 43920
[tauri-plugin-single-instance\src\platform_impl\windows.rs:170] encode_wide(&amp;class_name).as_ptr() = 0x0000017259cc6b30
[tauri-plugin-single-instance\src\platform_impl\windows.rs:171] encode_wide(&amp;window_name).as_ptr() = 0x0000017259cc6970
[tauri-plugin-single-instance\src\platform_impl\windows.rs:76] hwnd = 0
</code></pre>
<p>对比我们之前 <code>encode_wide</code> 函数<a href="#%E4%BD%86%E5%AE%83%E5%B9%B6%E4%B8%8D%E6%98%AF%E7%9C%9F%E7%9A%84%E4%BF%AE%E5%A4%8D">返回的结果</a>，<code>class_name</code> 开头的字符应该是 ASCII 字符 <code>z</code>（ASCII 码 122），因此通过 <code>encode_wide(&amp;class_name).as_ptr()</code> 传参的 <code>class.lpszClassName</code>，应当指向值为 &quot;z123456789012345-single-instance-class&quot; 的字符串，这在用例 <code>z12345678901234</code> 中行为符合预期；但在 <code>z123456789012345</code> 的用例中，<code>class.lpszClassName</code> 指向的却发生了变化（<code>*class.lpszClassName = 43920</code>），反推可以得知， <code>encode_wide(&amp;class_name).as_ptr()</code> 并没有成功地把指针传递给 <code>class.lpszClassName</code>。</p>
<h2 id="一语惊醒梦中人悬垂指针dangling"><a class="header" href="#一语惊醒梦中人悬垂指针dangling">一语惊醒梦中人：悬垂指针（dangling）！</a></h2>
<p><a href="https://github.com/Berrysoft">@Berrysoft</a> 指出， <code>encode_wide(&amp;class_name).as_ptr()</code> 这种写法由于直接对临时变量直接取指针，而临时变量 <code>encode_wide(&amp;class_name)</code> 会在执行完之后被马上释放结束生命周期，因此指向该临时变量的指针也会变成悬垂指针！临时变量的这一行为在 <a href="https://doc.rust-lang.org/stable/reference/expressions.html#temporaries">reference</a> 中有说明：</p>
<blockquote>
<p>When using a value expression in most place expression contexts, a temporary unnamed memory location is created and initialized to that value. The expression evaluates to that location instead, except if promoted to a static. <strong>The drop scope of the temporary is usually the end of the enclosing statement.</strong></p>
</blockquote>
<p>而解决该问题，只需要把提升变量的 lifetime，把要用到的变量提取出来，使其 lifetime 可以覆盖要用到的函数而不至于在语句执行完之后马上被回收。于是有了解决问题的 <a href="https://github.com/tauri-apps/tauri-plugin-single-instance/pull/6">PR</a>。</p>
<h2 id="那为什么在-format-的时候手动添加-0-后问题修复了呢"><a class="header" href="#那为什么在-format-的时候手动添加-0-后问题修复了呢">那为什么在 <code>format</code> 的时候手动添加 <code>\0</code> 后，问题“修复”了呢？</a></h2>
<p>这个问题依然悬而未决。有 TG 群友提出，可能是由于堆栈被破坏 “碰巧” 又指向了正确的字符串位置，而 <code>format</code> 后的变量又是 <code>'static</code> 的，因此能达到“修复”的效果，然而这依然是基于 bug/undefined behavior 的修复方案，因此仍然不可靠。后续原因排查出来后会更新博客~</p>
<h2 id="教训与经验"><a class="header" href="#教训与经验">教训与经验</a></h2>
<ol>
<li>实际上的排查过程，是分析过一次 <code>create_event_target_window</code> 的，然而当时由于需求紧急而找到了临时绕开的实现方案（把 <code>productName</code> 砍短），因此搁置了，也没有留下相关的排查记录文档，以致于后续在需求变更而变得必须排查清楚该问题时，走向了排查 <code>encode_wide</code> 的错误方向，虽然有了“修复”方案，但该方案仍然不可靠，因此可以视作浪费了实践。 <strong>形成记录首先方便的是以后的自己。</strong></li>
<li>凡是 <code>unsafe</code> 多查几遍。像本文涉及到的悬垂指针问题，在 safe rust 中因为 lifetime 不够长而会阻止编译，而 <code>unsafe</code> 块中使用裸指针是不会被编译器检查的，因此相关操作都要相当慎重。</li>
<li>多借助社区的力量。比起一个人钻牛角尖，多与社区讨论才容易跳出原本的死胡同，从而理解意识到原来思路的局限性。</li>
</ol>

                    </main>

                    <hr>
                    <script src="https://utteranc.es/client.js"
                            repo="huangjj27/blog-gitment"
                            issue-term="title"
                            label="utterances"
                            theme="github-light"
                            crossorigin="anonymous"
                            async>
                    </script>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->

                            <a rel="next" href="load-wasm-mistake.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

                    <a rel="next" href="load-wasm-mistake.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script type="text/javascript">
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->

    </body>
</html>
